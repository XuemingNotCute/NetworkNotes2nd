# （一）网络传输 

- 计算机网络
- second time
- 一点微小的笔记

-------------------


## 传送数据
一个 Web Server 向 Web client 传送数据的完整过程：
1. **User Data**: 需要传送的数据额是网络服务器的 HTML 页面；
2. **HTTP Data**: 应用协议HTTP报文头添加到HTML 数据之前。 
报头信息包括：服务器所使用的 HTTP 版本，状态编码。
HTTP应用层协议讲HTML格式的网页数据发送给传输层。
3. **TCP Segment**: TCP传输层用于管理网络服务器和客户端之间的会话。
4. **IP Packet**: IP网络层将IP信息添加到TCP信息之前。IP指定适当的源IP地址和目的IP地址。这些信息就构成了IP报文。
5. **Ethernet Frame**: Ethernet Protocol 添加到IP报文的两端之后，就形成了数据链路帧 Ethernet Frame。上述帧发送至通向网络客户端的路径上的最近一个路由器。
路由器移除以太网信息，观察IP报文，判定最佳路径。将报文插入一个新的帧，并发送至目标路径上下一个相邻路由器。
每一个路由器在转发之前都移除并添加新的数据链路层信息。
6. 数据通过互联网络传输，互联网络包括媒介和中间设备(物理层)。
7. 如上在不同layers之间自上而下封装传输，然后
8. 客户端接收到包含数据的数据链路帧（也可以叫以太帧），处理各层协议头，之后以添加时相反的顺序移除协议头。
也就是自下而上（layers）解封。
首先处理并移除以太网信息，之后是IP协议信息，之后是TCP信息，最后是HTTP信息。
9. 之后，将网页信息传递给客户端网页浏览器软件。  

## 数据封装
Q: 数据为什么需要封装？<br>
A: 
- 网络的本质是为了交换/传送信息。也就是把数据从网络源地址传送到目的地址。
- 在这个过程中，涉及到消息大小的问题。如果消息很大，比如是一个很大的视频文件，理论上，我们可以以大块非中断型流从网络源地址传送到网络的目的地址。这种大型非中断流有一个问题：是独占网络的，也就是同一时刻同一网络的其他设备就无法收发消息。因此可以想象，第一会造成延时，第二如果传输过程中因为某些原因失败了，整个数据流都会丢失需要全部重传。想象一下一个3.8G的视频你需要再传一次，其间你不能收发其他消息。
- 所以更好的做法是，将数据流分割(segmentation)为较小的片段。
- segmentation 带来两点好处：第一，网络上可以同时有多个对话交错进行。也就是multiplexing多路传输。第二，提高网络通讯的可靠新。主要因为各个数据片段从源地址到目的地址无需经过相同路径，如果一条路径被阻塞或者断开，其余消息可以从替代路径到达目的IP。而且一旦丢失只需要重传丢失的部分。
- 现在再来想想segmentation可能带来什么问题。有分割就有重组。如果多个信息片段，因为走了不同的路径或者因为重传，导致达到的先后顺序混乱。那我们如何重组呢？就会confused。
- 所以对于这个问题，我们可以对片段打上标签。Labeling provides for ordering and assembling the pieces when they arrive.
- 怎么打标签呢？应用层数据在传输过程中沿着协议栈传输，每一层协议都会向其中添加信息。这就是`封装`的过程。而数据片段在各层网络结构中采用的形式就称为 `Protocol Data Unit`.
- Data -> Segment -> Packet -> Frame -> Bits (Passing down the stack)
- 所以什么是封装呢？简单说，就是一个labeling的过程。复杂说，就是指在传输之前为数据添加额外的协议头信息的过程。
- 对上面的封装加深一点理解：给谁封装？源数据。封装什么？封装数层协议。为什么要封装数层协议？因为在网络上发送消息的时候，主机上的协议栈从上至下进行操作。
- 在此可以想想，标签里面需要有什么信息呢？
	- 每一个PDU的顺序
	- 源地址
	- 目的地址
	- 接收方是哪一个进程应该接收此信息？涉及到port
	- 目的物理地址（进入子网）
	- 差错校正信息
	- 重组数据的信息
	- ......
- 解封装。解封装的本质是因为 data passing down the layers stack. 然后同层之间虚拟意义上是直接传输的，之后 data passing up the layers stack. 解封装就是接收设备移除一层或多层协议头（标签）的过程。数据在协议栈中向上移动直到终端应用层伴随着解封装。
- 总而言之，网络的本质是为了传输。交通网络为了传输汽车或者交通工具，社交网络为了传递人。那么计算机网络就是为了传递信息。封装的目的是为了服务传输。去处理消息大小的问题。



## 访问本地资源
访问本地资源需要两种类型的地址：
- 网络层地址
- 数据链路层地址

网络层和数据链路层负责将数据从发送设备传输至接收设备。
两层协议都有源地址和目的地址，但两种地址的目的不同。
![](https://raw.githubusercontent.com/XuemingNotCute/MarkdownPhotos/master/1.PNG)

### 网络地址
- 网络前缀+主机。
- 同一本地网络中，网络前缀部分是相同的，只有主机设备地址部分不同。
- 源IP地址：发送设备，即客户端PC1的IP地址：192.168.1.110
- 目的IP地址：接收设备，即FTP服务器：192.168.1.9

### 数据链路地址
- 数据链路地址的目的是在同一网络中将数据链路帧从一个网络接口发送至另一个网络接口。
- 以太网LAN和无线网LAN是两种不同物理介质的网络示例，分别有自己的数据链路协议。
- 当IP报文的发送方和接收方位于同一网络，数据链路帧直接发送到接收设备。
- 以太网上数据链路地址就是以太网MAC地址。MAC地址是物理植入网卡的48比特地址。
- 源MAC地址：发送IP报文的PC1以太网卡MAC地址，AA-AA-AA-AA-AA-AA。
- 目的MAC地址：当发送设备与接收设备位于同一网络，即为接收设备的数据链路地址。本例
中，FTP MAC地址：CC-CC-CC-CC-CC-CC。
源和目的MAC地址添加到以太网帧中。


### MAC与IP地址
- `发送方必须知道接收方的物理和逻辑地址`。
- **逻辑地址**：发送方主机能够以多种方式学习到接收方的IP地址：比如域名系统（Domain Name System, DNS），或通过应用手动输入，如用户指定FTP地址。
- **物理地址**：以太网MAC地址是怎么识别的呢？发送方主机使用地址解析协议（Address ResolutionProtocol, ARP）以检测本地网络的所有MAC地址。
- **通过IP找MAC**：如图所示，发送主机在整个LAN发送ARP请求消息，这是一条广播消息。ARP请求包含目标设备的IP地址，LAN上的每一个设备都会检查该ARP请求，看看是否包含它自身的IP地址。只有符合该IP地址的设备才会发送ARP响应。ARP响应包含ARP请求中IP地址相对应的MAC地址。
![](https://raw.githubusercontent.com/XuemingNotCute/MarkdownPhotos/master/2.png)

## 访问远程资源

### 默认网关
- 当主机发送消息到远端网络，必须使用路由器，也称为默认网关。
- 默认网关就是位于发送主机同一网络上的路由器的接口IP地址。有一点很重要：本地网络上的所有主机都能够配置自己的默认网关地址。
- 如果该主机的TCP/IP设置中没有配置默认网关地址，或指定了错误的默认网关地址，则远端网络消息无法被送达。
- 如下图所示，LAN上的主机PC 1使用IP地址为192.168.1.1的R1作为默认网关，如果PDU的目的地址位于另一个网络，则主机将PDU发送至路由器上的默认网关。<br>
![](https://raw.githubusercontent.com/XuemingNotCute/MarkdownPhotos/master/3.png)



下图显示了客户端主机PC 1与远端IP网络服务器进行通讯的网络层地址与数据链路层地址：
![](https://raw.githubusercontent.com/XuemingNotCute/MarkdownPhotos/master/4.png)

### 网络地址
- 当报文的发送方与接收方位于不同网络，源和目的IP地址将会代表不同网络上的主机。
- 源IP地址：发送设备即客户端主机PC 1的IP地址：192.168.1.110。
- 目的IP地址：接收设备即网络服务器的IP地址：172.16.1.99。

### 数据链路地址
- 当报文的发送方与接收方位于不同网络，以太网数据链路帧无法直接被发送到目的主机。
- 以太网帧必须先发送给路由器或默认网关。本例中，默认网关是R1，R1的接口IP地址与PC 1属于同一网络，因此PC 1能够直接达到路由器。
- 源MAC地址：发送设备即PC 1的MAC地址，PC1的以太网接口MAC地址为：AA-AA-AA-AAAA-AA。
- 目的MAC地址：当报文的发送方与接收方位于不同网络，**这一值为路由器或默认网关的以太
网MAC地址**。本例中，即R1的以太网接口MAC地址，即：11-11-11-11-11-11。
- IP报文封装成的以太网帧先被传输至R1，R1再转发给目的地址即网络服务器。
- R1可以转发给另一个路由器，如果目的服务器所在网路连接至R1，则直接发送给服务器。在这里先转给R2，再转给 Web Server.
- 发送设备如何确定路由器的MAC地址？每一个设备通过自己的TCP/IP设置中的默认网关地址得知路由器的IP地址。之后，它通过ARP来得知默认网关的MAC地址，该MAC地址随后添加到帧中。


### 为什么只需要数据链路层地址(MAC地址)和网络层地址（IP地址）？
**Network Addresses and Data Link Addresses**
- Physical :  Timing and synchronization bits;
- Data Link : Destination and source physical addresses
- Network : Destination and source logical network addresses
- Transport :  Destination and source process number(ports)
- Upper Layers: Encoded application data

从最底层看，物理层只处理比特流；<br>
数据链路层的信息中包含物理网络地址；<br>
网络层包含逻辑网络地址；<br>
传输层包含目的应用，也就是目标端口；<br>
而再往上的会话层，表示层，应用层只是用来编码应用的数据；<br>
而发送方只需要知道接收方的物理地址和逻辑地址就可以，也就是数据链路层和网络层地址。<br>




